{% extends 'base.html' %}

{% block title %}Сканирование QR{% endblock %}

{% block content %}
<h2>Сканирование QR-кода</h2>

<!-- Кнопка для запуска камеры -->
<button id="start-camera">Запустить камеру</button>

<!-- Элемент для отображения видео с камеры -->
<video id="camera" width="100%" height="auto" autoplay playsinline muted></video>

<!-- Место для отображения результата -->
<p id="result"></p>

<script>
    let videoStream;

    // Функция для запуска камеры
    document.getElementById('start-camera').addEventListener('click', async () => {
        const cameraElement = document.getElementById('camera');

        try {
            // Запрашиваем доступ к камере
            videoStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }, // Используем заднюю камеру
                audio: false // Аудио не нужно
            });

            // Подключаем поток к видеоэлементу
            cameraElement.srcObject = videoStream;

            // Ожидаем, пока видео загрузится и начнет воспроизводиться
            cameraElement.onloadedmetadata = () => {
                cameraElement.play();
            };

            // QR-код: инициализация сканера (по желанию)
            const html5QrCode = new Html5Qrcode("camera");
            html5QrCode.start(
                { facingMode: "environment" }, 
                {
                    fps: 10,  // Количество кадров в секунду
                    qrbox: 250  // Размер области для сканирования
                },
                qrCodeMessage => {
                    // Обработка QR-кода
                    document.getElementById('result').innerText = `QR-код: ${qrCodeMessage}`;
                },
                errorMessage => {
                    console.log("Ошибка при сканировании QR: ", errorMessage);
                }
            );
        } catch (err) {
            console.error("Ошибка при доступе к камере: ", err);
            alert("Не удалось получить доступ к камере. Проверьте настройки браузера.");
        }
    });

    // Остановка камеры при необходимости (можно добавить кнопку)
    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
        }
    }
</script>

{% endblock %}

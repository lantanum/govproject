{% extends 'base.html' %}

{% block title %}Сканирование QR{% endblock %}

{% block content %}
<h2>Сканирование QR-кода</h2>
<button id="start-camera">Запустить камеру</button>
<video id="camera" autoplay width="100%" height="auto"></video>
<canvas id="qr-canvas" style="display: none;"></canvas>
<p id="result"></p>

<script>
    const startCameraButton = document.getElementById("start-camera");
    const videoElement = document.getElementById("camera");
    const canvas = document.getElementById("qr-canvas");
    const resultElement = document.getElementById("result");

    startCameraButton.addEventListener("click", () => {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then((stream) => {
                    videoElement.srcObject = stream;
                    videoElement.play();

                    // Запуск логики сканирования QR-кода
                    const qrScanner = setInterval(() => {
                        const ctx = canvas.getContext("2d");
                        canvas.width = videoElement.videoWidth;
                        canvas.height = videoElement.videoHeight;
                        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

                        // Используем стороннюю библиотеку jsQR
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const qrCode = jsQR(imageData.data, imageData.width, imageData.height);

                        if (qrCode) {
                            clearInterval(qrScanner); // Останавливаем процесс сканирования
                            resultElement.textContent = "QR-код найден: " + qrCode.data;

                            // Отправляем данные QR-кода на сервер
                            fetch("", {
                                method: "POST",
                                headers: {
                                    "X-CSRFToken": "{{ csrf_token }}",
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({ qr_data: qrCode.data })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    resultElement.textContent = "Посещение зарегистрировано!";
                                } else {
                                    resultElement.textContent = "Ошибка: " + data.error;
                                }
                            });
                        }
                    }, 500); // Сканировать каждые 500 мс
                })
                .catch((err) => {
                    console.error("Ошибка при доступе к камере: ", err);
                    alert("Не удалось получить доступ к камере.");
                });
        } else {
            alert("Ваш браузер не поддерживает доступ к камере.");
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.min.js"></script> <!-- Подключаем jsQR -->
{% endblock %}
